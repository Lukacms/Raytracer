name: CI Raytracer

on:
  pull_request:
    branches-ignore:
      - feature/ignore
  push:
    branches-ignore:
      - feature/ignore

env:
  EXECUTABLE: "raytracer"
  MIRROR_URL: "git@github.com:EpitechPromo2026/B-OOP-400-BDX-4-1-raytracer-luka.camus.git"

jobs:
  check_repository_cleanliness:
    name: "Check if the repository is clean and void of any unwanted files (temp, files, binary files, etc.)"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Scan files
      run: |
        arr=($(find . \( -name "#*#" -o -name "*~" \
        -o -name "*.o" -o -name "*.a" \
        -o -name "*.so" -o -name "*.gcno" -o -name "*.gcda" -o -name "*.gcov" \
         -o -path '*tmp/*' \)))
        for i in ${arr[@]}; do echo "::error file=$i,line=1,endLine=1,title=Unwanted file detected::$i"; done
        if ((${#arr[@]})); then
          exit 1
        fi

  job_run_program:
    needs: check_repository_cleanliness
    runs-on: ubuntu-latest
    steps:
    - name : Install packages
      run: |
          sudo apt-get update -qq
          sudo apt-get install -y ninja-build clang-tidy-12 ccache
          sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-12 100
          sudo apt-get install -y --no-install-recommends nlohmann-json3-dev libsfml-dev catch2
          clang++ --version
          clang-tidy --version
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Compilation test
      run: ./compile.sh --gcc
      timeout-minutes: 2
    - name: Back to root
      run:  cd ..
    - name: Check executable files exists
      run: |
        IFS=',' read -ra ADDR <<< $EXECUTABLES
        for i in "${ADDR[@]}"; do
          if [[ ! -x "./${i}" ]]; then
            exit 1
          fi
        done

  job_run_tests:
    name: Run tests, but is not obligated to succeed to push
    needs: job_run_program
    runs-on: ubuntu-latest
    steps:
    - name : Install packages
      run: |
          sudo apt-get update -qq
          sudo apt-get install -y ninja-build clang-tidy-12 ccache
          sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-12 100
          sudo apt-get install -y --no-install-recommends nlohmann-json3-dev libsfml-dev catch2
          clang++ --version
          clang-tidy --version
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Run tests
      run: |
        rm -rf build
        ./compile.sh --tests
      timeout-minutes: 10

  push_to_mirror:
    if: ${{ github.event_name == 'push' }}
    needs: job_run_program
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: pixta-dev/repository-mirroring-action@v1
        with:
          ssh_private_key:
            ${{ secrets.SSH_PRIVATE_KEY }}
          target_repo_url: ${{ env.MIRROR_URL }}
